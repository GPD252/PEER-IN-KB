<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure P2P Messenger 2025</title>
    <!-- PeerJS for Global Connectivity -->
    <script src="cdn.jsdelivr.net"></script>
    <style>
        :root { --bg: #0b141a; --sidebar: #111b21; --header: #202c33; --accent: #00a884; --text: #e9edef; --msg-me: #005c4b; --msg-peer: #202c33; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* Step 1: Login Screen Styles */
        #auth-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .auth-card { background: var(--sidebar); padding: 30px; border-radius: 12px; width: 320px; text-align: center; border: 1px solid #333; }
        .tab-btn { padding: 10px; cursor: pointer; opacity: 0.5; flex: 1; border-bottom: 2px solid transparent; }
        .tab-btn.active { opacity: 1; border-bottom-color: var(--accent); color: var(--accent); }

        /* Step 2: Main Sidebar Styles */
        .sidebar { width: 30%; min-width: 300px; border-right: 1px solid #333; background: var(--sidebar); display: flex; flex-direction: column; position: relative; }
        .sidebar-header { background: var(--header); padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; }
        .chat-list { flex: 1; overflow-y: auto; }
        .chat-item { padding: 15px; display: flex; align-items: center; border-bottom: 1px solid #222; cursor: pointer; transition: 0.2s; }
        .chat-item:hover { background: #2a3942; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; background: #444; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px; }

        /* Main Chat Styles */
        .main-chat { flex: 1; display: flex; flex-direction: column; background: #0b141a url('user-images.githubusercontent.com'); background-blend-mode: overlay; }
        .messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        .msg { max-width: 65%; padding: 8px 12px; border-radius: 8px; margin-bottom: 5px; font-size: 14px; }
        .msg.me { align-self: flex-end; background: var(--msg-me); }
        .msg.peer { align-self: flex-start; background: var(--msg-peer); }

        /* Floating Plus Button */
        .fab { position: absolute; bottom: 30px; right: 25px; width: 55px; height: 55px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 100; color: white; }

        /* Modal for Adding Friends */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 10000; }
        input { width: 100%; padding: 12px; margin-bottom: 10px; background: #2a3942; border: none; color: white; border-radius: 8px; box-sizing: border-box; }
        button { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<!-- Step 1: Login/Register Overlay -->
<div id="auth-overlay">
    <div class="auth-card">
        <h2 style="color:var(--accent)">üîê Messenger 2025</h2>
        <div style="display:flex; margin-bottom:20px;">
            <div id="l-tab" class="tab-btn active" onclick="setMode('login')">Login</div>
            <div id="r-tab" class="tab-btn" onclick="setMode('register')">Register</div>
        </div>
        <input type="text" id="auth-user" placeholder="Username (ID)">
        <input type="password" id="auth-pass" placeholder="Password">
        <button onclick="auth()" id="auth-btn">Enter Chat</button>
    </div>
</div>

<!-- Step 2: Main Chat Interface (Hidden by Default) -->
<div class="sidebar hidden" id="main-sidebar">
    <div class="sidebar-header">
        <div id="my-pic" class="avatar" style="background:var(--accent)">U</div>
        <div style="font-size: 12px; color: var(--accent)">‚óè Active</div>
    </div>
    <div class="chat-list" id="chat-list"></div>
    <!-- Floating (+) Button -->
    <div class="fab" onclick="showModal()">+</div>
</div>

<div class="main-chat hidden" id="main-view">
    <div style="margin: auto; text-align: center; opacity: 0.3;">
        <img src="cdn-icons-png.flaticon.com" width="100">
        <h3>End-to-End Encrypted</h3>
        <p>(+) icon se dost add karein.</p>
    </div>
</div>

<!-- Chat Window -->
<div class="main-chat hidden" id="chat-window">
    <div class="sidebar-header">
        <div id="peer-pic" class="avatar" style="width:35px; height:35px; font-size:14px;">P</div>
        <b id="peer-name">Dost</b>
    </div>
    <div class="messages" id="msgs-box"></div>
    <div style="background:var(--header); padding:10px; display:flex;">
        <input type="text" id="m-input" placeholder="Type message..." style="margin:0; flex:1;">
        <button onclick="send()" style="width:auto; margin-left:10px; padding:0 20px;">Send</button>
    </div>
</div>

<!-- Step 3: Add Friend Modal (Only opens on FAB click) -->
<div id="add-modal" class="modal hidden">
    <div class="auth-card">
        <h3>Add Friend</h3>
        <input type="text" id="target-id" placeholder="Dost ka ID">
        <input type="text" id="otp-code" placeholder="Verification Token (6 Digit)">
        <button onclick="connectPeer()">Verify & Connect</button>
        <button onclick="hideModal()" style="background:#444; margin-top:5px;">Cancel</button>
    </div>
</div>

<script>
    let mode = 'login', myPeer, myId, conn;
    let friends = JSON.parse(localStorage.getItem('f_list_final') || "[]");

    function setMode(m) {
        mode = m;
        document.getElementById('l-tab').className = m === 'login' ? 'tab-btn active' : 'tab-btn';
        document.getElementById('r-tab').className = m === 'register' ? 'tab-btn active' : 'tab-btn';
        document.getElementById('auth-btn').innerText = m === 'login' ? 'Login Now' : 'Create Account';
    }

    function auth() {
        const u = document.getElementById('auth-user').value.trim();
        const p = document.getElementById('auth-pass').value;
        if(!u || !p) return alert("Sari details bhariye!");

        if(mode === 'register') {
            localStorage.setItem("pass_"+u, p);
            alert("Registration Safal! Ab Login karein.");
            setMode('login');
        } else {
            if(localStorage.getItem("pass_"+u) === p) {
                myId = u;
                startApp();
            } else { alert("Galat Password!"); }
        }
    }

    function startApp() {
        myPeer = new Peer(myId);
        myPeer.on('open', (id) => {
            document.getElementById('auth-overlay').classList.add('hidden');
            document.getElementById('main-sidebar').classList.remove('hidden');
            document.getElementById('main-view').classList.remove('hidden');
            document.getElementById('my-pic').innerText = myId.charAt(0).toUpperCase();
            updateSidebar();
        });

        myPeer.on('connection', (c) => {
            conn = c;
            conn.on('data', d => appendMsg('peer', d));
            saveFriend(c.peer);
            openChat(c.peer);
        });
    }

    function showModal() { document.getElementById('add-modal').classList.remove('hidden'); }
    function hideModal() { document.getElementById('add-modal').classList.add('hidden'); }

    function connectPeer() {
        const tid = document.getElementById('target-id').value.trim();
        if(!tid || tid === myId) return alert("Sahi ID dalein!");

        conn = myPeer.connect(tid);
        conn.on('open', () => {
            saveFriend(tid);
            openChat(tid);
            hideModal();
        });
        conn.on('data', d => appendMsg('peer', d));
    }

    function saveFriend(id) {
        if(!friends.includes(id)) {
            friends.push(id);
            localStorage.setItem('f_list_final', JSON.stringify(friends));
            updateSidebar();
        }
    }

    function updateSidebar() {
        const cont = document.getElementById('chat-list');
        cont.innerHTML = "";
        friends.forEach(f => {
            const div = document.createElement('div');
            div.className = 'chat-item';
            div.innerHTML = `<div class="avatar">${f.charAt(0).toUpperCase()}</div> <div><b>${f}</b><br><small style="color:#888">Online</small></div>`;
            div.onclick = () => { conn = myPeer.connect(f); openChat(f); };
            cont.appendChild(div);
        });
    }

    function openChat(name) {
        document.getElementById('main-view').classList.add('hidden');
        document.getElementById('chat-window').classList.remove('hidden');
        document.getElementById('peer-name').innerText = name;
        document.getElementById('peer-pic').innerText = name.charAt(0).toUpperCase();
        document.getElementById('msgs-box').innerHTML = "";
    }

    function send() {
        const val = document.getElementById('m-input').value;
        if(!val || !conn) return;
        conn.send(val);
        appendMsg('me', val);
        document.getElementById('m-input').value = "";
    }

    function appendMsg(type, text) {
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        div.innerText = text;
        document.getElementById('msgs-box').appendChild(div);
        document.getElementById('msgs-box').scrollTop = document.getElementById('msgs-box').scrollHeight;
    }
</script>
</body>
</html>
