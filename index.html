<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite P2P Messenger 2025</title>
    <script src="cdnjs.cloudflare.com"></script>
    <style>
        :root { --bg: #090c10; --panel: #161b22; --accent: #238636; --text: #c9d1d9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .box { width: 90%; max-width: 450px; background: var(--panel); padding: 25px; border-radius: 12px; border: 1px solid #30363d; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h2 { text-align: center; color: var(--accent); }
        input, textarea { width: 100%; background: #0d1117; border: 1px solid #30363d; color: white; padding: 12px; margin: 10px 0; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        button { width: 100%; background: var(--accent); color: white; border: none; padding: 12px; cursor: pointer; border-radius: 6px; font-weight: bold; margin-top: 10px; }
        .hidden { display: none; }
        #chat-window { height: 200px; overflow-y: auto; background: #0d1117; border: 1px solid #30363d; padding: 10px; margin: 10px 0; font-size: 13px; }
        .video-box { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        video { width: 100%; border-radius: 6px; background: #000; height: 120px; object-fit: cover; }
        .link-btn { color: #58a6ff; cursor: pointer; font-size: 12px; text-decoration: underline; display: block; text-align: center; margin-top: 10px; }
    </style>
</head>
<body>

<!-- Auth Screen -->
<div id="auth-screen" class="box">
    <h2 id="auth-title">Welcome Back</h2>
    <input type="text" id="username" placeholder="Username">
    <input type="password" id="password" placeholder="Password / Private ID">
    <button onclick="handleAuth()" id="auth-btn">Login</button>
    <span class="link-btn" onclick="toggleAuthMode()" id="toggle-text">Naya Account banayein (Register)</span>
</div>

<!-- Main Chat App -->
<div id="app-screen" class="box hidden">
    <h3>ðŸ‘¤ <span id="user-display"></span></h3>
    <div id="setup-section">
        <button onclick="startHandshake()">1. Generate Short Code</button>
        <textarea id="my-code" readonly placeholder="Aapka Code..."></textarea>
        <textarea id="peer-code" placeholder="Partner ka Code yahan paste karein..."></textarea>
        <button onclick="connect()" style="background: #1f6feb;">2. Connect Now</button>
    </div>

    <div id="chat-section" class="hidden">
        <div class="video-box">
            <video id="localVid" autoplay muted playsinline></video>
            <video id="remoteVid" autoplay playsinline></video>
        </div>
        <div id="chat-window"></div>
        <input type="text" id="msg-input" placeholder="Type message...">
        <button onclick="sendMsg()">Send</button>
    </div>
</div>

<script>
    let isRegisterMode = false;
    let currentUser = null;
    let pc, dc, stream;
    const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

    function toggleAuthMode() {
        isRegisterMode = !isRegisterMode;
        document.getElementById('auth-title').innerText = isRegisterMode ? "Register User" : "Welcome Back";
        document.getElementById('auth-btn').innerText = isRegisterMode ? "Create Account" : "Login";
        document.getElementById('toggle-text').innerText = isRegisterMode ? "Already have account? Login" : "Naya Account banayein (Register)";
    }

    function handleAuth() {
        const user = document.getElementById('username').value;
        const pass = document.getElementById('password').value;
        if (!user || !pass) return alert("Details bhariye!");

        if (isRegisterMode) {
            localStorage.setItem(`pwd_${user}`, pass);
            alert("Account Ban gaya! Ab login karein.");
            toggleAuthMode();
        } else {
            if (localStorage.getItem(`pwd_${user}`) === pass) {
                currentUser = user;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                document.getElementById('user-display').innerText = currentUser;
                loadHistory();
            } else {
                alert("Galat ID ya Password!");
            }
        }
    }

    async function startHandshake() {
        stream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
        document.getElementById('localVid').srcObject = stream;
        setupPeer(true);
    }

    function setupPeer(isOffer) {
        pc = new RTCPeerConnection(config);
        stream.getTracks().forEach(t => pc.addTrack(t, stream));
        pc.ontrack = e => document.getElementById('remoteVid').srcObject = e.streams[0];

        if(isOffer) {
            dc = pc.createDataChannel("chat");
            setupDC();
            pc.createOffer().then(o => pc.setLocalDescription(o));
        } else {
            pc.ondatachannel = e => { dc = e.channel; setupDC(); };
        }

        pc.onicecandidate = e => {
            if(!e.candidate) {
                // Compression for shorter codes
                const shortCode = LZString.compressToEncodedURIComponent(JSON.stringify(pc.localDescription));
                document.getElementById('my-code').value = shortCode;
            }
        };
    }

    async function connect() {
        const peerCode = document.getElementById('peer-code').value;
        if(!peerCode) return;
        const desc = JSON.parse(LZString.decompressFromEncodedURIComponent(peerCode));
        if(!pc) await startHandshake();
        await pc.setRemoteDescription(new RTCSessionDescription(desc));
        if(desc.type === "offer") {
            const ans = await pc.createAnswer();
            await pc.setLocalDescription(ans);
        }
    }

    function setupDC() {
        dc.onopen = () => {
            document.getElementById('setup-section').classList.add('hidden');
            document.getElementById('chat-section').classList.remove('hidden');
        };
        dc.onmessage = e => saveAndShow("Partner", e.data);
    }

    function sendMsg() {
        const i = document.getElementById('msg-input');
        dc.send(i.value);
        saveAndShow("Me", i.value);
        i.value = "";
    }

    function saveAndShow(s, t) {
        const key = `chat_${currentUser}`;
        let h = JSON.parse(localStorage.getItem(key) || "[]");
        h.push({s, t});
        localStorage.setItem(key, JSON.stringify(h));
        const w = document.getElementById('chat-window');
        w.innerHTML += `<div><b>${s}:</b> ${t}</div>`;
        w.scrollTop = w.scrollHeight;
    }

    function loadHistory() {
        const h = JSON.parse(localStorage.getItem(`chat_${currentUser}`) || "[]");
        h.forEach(m => {
            document.getElementById('chat-window').innerHTML += `<div><b>${m.s}:</b> ${m.t}</div>`;
        });
    }
</script>
</body>
</html>
