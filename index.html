<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Private Messenger 2025</title>
    <!-- Firebase SDK (Authoritative Source for 2025) -->
    <script src="www.gstatic.com"></script>
    <script src="www.gstatic.com"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --btn-green: #238636; --btn-blue: #1f6feb; --text: #c9d1d9; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { width: 95%; max-width: 420px; background: var(--card); padding: 30px; border-radius: 15px; border: 1px solid #30363d; box-shadow: 0 15px 35px rgba(0,0,0,0.6); }
        h2 { text-align: center; margin-bottom: 20px; color: #58a6ff; }
        .tab-group { display: flex; margin-bottom: 20px; border-bottom: 1px solid #333; }
        .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; opacity: 0.6; transition: 0.3s; }
        .tab.active { border-bottom: 3px solid var(--btn-blue); opacity: 1; font-weight: bold; }
        input { width: 100%; background: #0d1117; border: 1px solid #30363d; color: white; padding: 14px; margin-bottom: 15px; border-radius: 8px; box-sizing: border-box; outline: none; font-size: 16px; }
        input:focus { border-color: var(--btn-blue); box-shadow: 0 0 5px rgba(31, 111, 235, 0.5); }
        button { width: 100%; padding: 14px; border-radius: 8px; border: none; color: white; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; position: relative; }
        #auth-btn { background: var(--btn-green); }
        #auth-btn:hover { background: #2ea043; transform: translateY(-2px); }
        #auth-btn:active { transform: translateY(0); }
        .hidden { display: none; }
        #status-bar { font-size: 12px; text-align: center; margin-bottom: 15px; color: #8b949e; }
        #chat-box { height: 300px; overflow-y: auto; background: #0d1117; border: 1px solid #30363d; padding: 15px; border-radius: 10px; margin-bottom: 15px; display: flex; flex-direction: column; }
        .video-feed { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        video { width: 100%; height: 120px; background: #000; border-radius: 8px; border: 1px solid #444; object-fit: cover; }
    </style>
</head>
<body>

<div class="container" id="main-container">
    <div id="status-bar">System initializing...</div>
    
    <!-- AUTHENTICATION SECTION -->
    <div id="auth-section">
        <h2>üîê Private Chat</h2>
        <div class="tab-group">
            <div id="login-tab" class="tab active" onclick="switchTab('login')">Login</div>
            <div id="register-tab" class="tab" onclick="switchTab('register')">Register</div>
        </div>
        <input type="text" id="username" placeholder="Username (Unique ID)">
        <input type="password" id="password" placeholder="Password">
        <button id="auth-btn" onclick="processAuth()">Enter Messenger</button>
    </div>

    <!-- CONNECTION SECTION -->
    <div id="connect-section" class="hidden">
        <h2>üëã Welcome, <span id="user-tag" style="color:#58a6ff;"></span></h2>
        <p style="text-align:center; font-size:14px; color:#8b949e;">Dost ka Username dalkar video call start karein:</p>
        <input type="text" id="peer-id" placeholder="Partner's Username">
        <button id="call-btn" onclick="initiateConnection()" style="background:var(--btn-blue);">Start High-Quality Call</button>
    </div>

    <!-- CHAT SECTION -->
    <div id="chat-section" class="hidden">
        <div class="video-feed">
            <video id="my-video" autoplay muted playsinline></video>
            <video id="peer-video" autoplay playsinline></video>
        </div>
        <div id="chat-box"></div>
        <div style="display:flex; gap:10px;">
            <input type="text" id="msg-input" placeholder="Type message..." style="margin-bottom:0;">
            <button onclick="sendMsg()" style="width:80px; background:var(--btn-green); padding:0;">Send</button>
        </div>
    </div>
</div>

<script>
    // 2025 Secure Database Config
    const firebaseConfig = { databaseURL: "p2p-live-2025-default-rtdb.firebaseio.com" };
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const db = firebase.database();

    let currentMode = 'login';
    let myID, peerID, pc, dc, stream;
    const rtcConfig = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

    // Update Status
    db.ref(".info/connected").on("value", (snap) => {
        document.getElementById('status-bar').innerText = snap.val() ? "üü¢ Online - Secure Connection" : "üî¥ Offline - Reconnecting...";
    });

    function switchTab(mode) {
        currentMode = mode;
        document.getElementById('login-tab').className = mode === 'login' ? 'tab active' : 'tab';
        document.getElementById('register-tab').className = mode === 'register' ? 'tab active' : 'tab';
        document.getElementById('auth-btn').innerText = mode === 'login' ? 'Login Now' : 'Create Account';
    }

    async function processAuth() {
        const u = document.getElementById('username').value.trim();
        const p = document.getElementById('password').value;
        if (!u || !p) return alert("Sari fields bhariye!");

        const ref = db.ref('users/' + u);
        const snap = await ref.once('value');

        if (currentMode === 'register') {
            if (snap.exists()) return alert("Username pehle se hai! Login karein.");
            await ref.set({ pw: p, status: 'online' });
            alert("Success! Ab Login karein.");
            switchTab('login');
        } else {
            if (!snap.exists() || snap.val().pw !== p) return alert("Galat ID ya Password!");
            myID = u;
            showConnectScreen();
        }
    }

    function showConnectScreen() {
        document.getElementById('auth-section').classList.add('hidden');
        document.getElementById('connect-section').classList.remove('hidden');
        document.getElementById('user-tag').innerText = myID;
        // Listen for Incoming
        db.ref('signals/' + myID).on('value', async s => {
            const d = s.val();
            if (d && d.type === 'offer') {
                if (confirm(d.from + " wants to call. Accept?")) {
                    peerID = d.from;
                    await handleAccept(d.sdp);
                }
            }
        });
    }

    async function initiateConnection() {
        peerID = document.getElementById('peer-id').value.trim();
        if (!peerID || peerID === myID) return alert("Sahi Username dalein!");
        
        stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('my-video').srcObject = stream;
        
        pc = new RTCPeerConnection(rtcConfig);
        stream.getTracks().forEach(t => pc.addTrack(t, stream));
        dc = pc.createDataChannel("chat");
        setupDC();

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await db.ref('signals/' + peerID).set({ type: 'offer', from: myID, sdp: JSON.stringify(offer) });

        db.ref('signals/' + myID).on('value', async s => {
            if (s.val() && s.val().type === 'answer') {
                await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(s.val().sdp)));
                showChat();
            }
        });
    }

    async function handleAccept(sdp) {
        stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('my-video').srcObject = stream;
        pc = new RTCPeerConnection(rtcConfig);
        stream.getTracks().forEach(t => pc.addTrack(t, stream));
        pc.ondatachannel = e => { dc = e.channel; setupDC(); };
        await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(sdp)));
        const ans = await pc.createAnswer();
        await pc.setLocalDescription(ans);
        await db.ref('signals/' + peerID).set({ type: 'answer', from: myID, sdp: JSON.stringify(ans) });
        showChat();
    }

    function setupDC() {
        dc.onopen = () => showChat();
        dc.onmessage = e => appendMsg("Partner", e.data);
    }

    function showChat() {
        document.getElementById('connect-section').classList.add('hidden');
        document.getElementById('chat-section').classList.remove('hidden');
    }

    function sendMsg() {
        const i = document.getElementById('msg-input');
        if (!i.value) return;
        dc.send(i.value);
        appendMsg("Me", i.value);
        i.value = "";
    }

    function appendMsg(s, t) {
        const b = document.getElementById('chat-box');
        b.innerHTML += `<div><b>${s}:</b> ${t}</div>`;
        b.scrollTop = b.scrollHeight;
    }
</script>
</body>
</html>
